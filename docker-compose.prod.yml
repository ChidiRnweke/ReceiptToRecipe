services:
  app:
    # Use the image built by GitHub Actions
    image: ghcr.io/chidirnweke/receipttorecipe:latest
    container_name: receipt2recipe
    restart: unless-stopped
    expose:
      - "3000"
    environment:
      - ORIGIN=https://receipttorecipe.chidinweke.be
      - BODY_SIZE_LIMIT=10M

      - INFISICAL_CLIENT_ID=${INFISICAL_CLIENT_ID}
      - INFISICAL_CLIENT_SECRET=${INFISICAL_CLIENT_SECRET}
      - INFISICAL_PROJECT_ID=${INFISICAL_PROJECT_ID}
      - INFISICAL_URL=${INFISICAL_URL}
      - INFISICAL_ENVIRONMENT=prod
      # OpenTelemetry
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel_collector:4317
      - OTEL_SERVICE_NAME=receipt2recipe

    networks:
      - reverse-proxy
      - postgres-network
      - minio-network
      - telemetry-network

    labels:
      caddy: receipttorecipe.chidinweke.be
      caddy.reverse_proxy: "{{upstreams 3000}}"

  migrate:
    image: ghcr.io/chidirnweke/receipttorecipe:latest
    container_name: receipt2recipe-migrate
    restart: "no"
    profiles: ["setup"]
    command: node scripts/prod-migrate.js
    environment:
      # App Infisical credentials (for reading/writing app secrets)
      - INFISICAL_CLIENT_ID=${INFISICAL_CLIENT_ID}
      - INFISICAL_CLIENT_SECRET=${INFISICAL_CLIENT_SECRET}
      - INFISICAL_PROJECT_ID=${INFISICAL_PROJECT_ID}
      - INFISICAL_ENVIRONMENT=prod
      # Admin Infisical credentials (for provisioning database)
      - INFISICAL_ADMIN_CLIENT_ID=${INFISICAL_ADMIN_CLIENT_ID}
      - INFISICAL_ADMIN_CLIENT_SECRET=${INFISICAL_ADMIN_CLIENT_SECRET}
      - INFISICAL_ADMIN_PROJECT_ID=${INFISICAL_ADMIN_PROJECT_ID}
      - INFISICAL_URL=${INFISICAL_URL}
      # Project-specific database config
      - DB_NAME=r2r
      - DB_USER=r2r
      # OpenTelemetry
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel_collector:4317
      - OTEL_SERVICE_NAME=receipt2recipe-migrate
    labels:
      komodo.skip: # Prevent Komodo from stopping with StopAllContainers
    networks:
      - reverse-proxy
      - postgres-network
      - minio-network
      - telemetry-network

  minio-init:
    image: ghcr.io/chidirnweke/receipttorecipe:latest
    container_name: receipt2recipe-minio-init
    restart: "no"
    profiles: ["setup"]
    command: node scripts/prod-minio-init.js
    environment:
      # App Infisical credentials (for reading/writing app secrets)
      - INFISICAL_CLIENT_ID=${INFISICAL_CLIENT_ID}
      - INFISICAL_CLIENT_SECRET=${INFISICAL_CLIENT_SECRET}
      - INFISICAL_PROJECT_ID=${INFISICAL_PROJECT_ID}
      - INFISICAL_ENVIRONMENT=prod
      # Admin Infisical credentials (for provisioning MinIO)
      - INFISICAL_ADMIN_CLIENT_ID=${INFISICAL_ADMIN_CLIENT_ID}
      - INFISICAL_ADMIN_CLIENT_SECRET=${INFISICAL_ADMIN_CLIENT_SECRET}
      - INFISICAL_ADMIN_PROJECT_ID=${INFISICAL_ADMIN_PROJECT_ID}
      - INFISICAL_URL=${INFISICAL_URL}
      # Project-specific MinIO config
      - MINIO_BUCKET=r2r-images
      # OpenTelemetry
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel_collector:4317
      - OTEL_SERVICE_NAME=receipt2recipe-minio-init
    labels:
      komodo.skip: # Prevent Komodo from stopping with StopAllContainers
    networks:
      - reverse-proxy
      - postgres-network
      - minio-network
      - telemetry-network

networks:
  reverse-proxy:
    external: true
  postgres-network:
    external: true
  minio-network:
    external: true
  telemetry-network:
    external: true
